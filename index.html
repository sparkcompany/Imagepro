<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatApp</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #auth-container, #app-container { display: none; }
        #auth-container.active, #app-container.active { display: block; }
        input[type="text"], input[type="password"], input[type="email"] { width: 100%; padding: 8px; margin: 10px 0; display: inline-block; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #4CAF50; color: white; padding: 10px 15px; margin: 8px 0; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #45a049; }
        .user-card, .request-card, .friend-card { border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        #chat-container { display: none; }
        #chat-messages { height: 300px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
        .message { margin-bottom: 5px; }
        .message.sent { text-align: right; }
        .message .sender { font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ChatApp</h1>

        <!-- Authentication Section -->
        <div id="auth-container">
            <h2>Login or Sign Up</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button id="login-btn">Login</button>
            <button id="signup-btn">Sign Up</button>
        </div>

        <!-- Main App Section -->
        <div id="app-container">
            <p>Welcome, <span id="current-user"></span>! <button id="logout-btn">Logout</button></p>

            <!-- User Profile -->
            <div>
                <h3>My Profile</h3>
                <p><strong>Username:</strong> <span id="profile-username"></span></p>
                <p><strong>Town:</strong> <span id="profile-town"></span></p>
            </div>

            <hr>

            <!-- Find Friends -->
            <div>
                <h3>Find Friends</h3>
                <input type="text" id="search-username" placeholder="Enter username">
                <button id="search-btn">Search</button>
                <div id="search-results"></div>
            </div>

            <hr>

            <!-- Friend Requests -->
            <div>
                <h3>Friend Requests</h3>
                <div id="friend-requests"></div>
            </div>

            <hr>

            <!-- Friends List -->
            <div>
                <h3>Friends</h3>
                <div id="friends-list"></div>
            </div>

            <hr>

            <!-- Chat Section -->
            <div id="chat-container">
                <h3>Chat with <span id="chat-with-username"></span></h3>
                <div id="chat-messages"></div>
                <input type="text" id="message-input" placeholder="Type a message...">
                <button id="send-message-btn">Send</button>
            </div>
        </div>
    </div>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
      import { getDatabase, ref, set, get, onValue, push, child } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyAlVd0FzdmXT5GPheciSnYu-PAA4fxB76k",
        authDomain: "studio-x1ld3.firebaseapp.com",
        databaseURL: "https://studio-x1ld3-default-rtdb.firebaseio.com",
        projectId: "studio-x1ld3",
        storageBucket: "studio-x1ld3.firebasestorage.app",
        messagingSenderId: "423830962515",
        appId: "1:423830962515:web:ca42a576c4d080a40461a6"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getDatabase(app);

      const authContainer = document.getElementById('auth-container');
      const appContainer = document.getElementById('app-container');
      const loginBtn = document.getElementById('login-btn');
      const signupBtn = document.getElementById('signup-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const currentUserSpan = document.getElementById('current-user');
      const profileUsernameSpan = document.getElementById('profile-username');
      const profileTownSpan = document.getElementById('profile-town');
      const searchUsernameInput = document.getElementById('search-username');
      const searchBtn = document.getElementById('search-btn');
      const searchResultsDiv = document.getElementById('search-results');
      const friendRequestsDiv = document.getElementById('friend-requests');
      const friendsListDiv = document.getElementById('friends-list');
      const chatContainer = document.getElementById('chat-container');
      const chatWithUsernameSpan = document.getElementById('chat-with-username');
      const chatMessagesDiv = document.getElementById('chat-messages');
      const messageInput = document.getElementById('message-input');
      const sendMessageBtn = document.getElementById('send-message-btn');

      let currentUserId = null;
      let currentChattingWith = null;

      // Auth state observer
      onAuthStateChanged(auth, user => {
          if (user) {
              currentUserId = user.uid;
              authContainer.classList.remove('active');
              appContainer.classList.add('active');
              currentUserSpan.textContent = user.email;
              loadUserProfile(currentUserId);
              loadFriendRequests(currentUserId);
              loadFriends(currentUserId);
          } else {
              currentUserId = null;
              authContainer.classList.add('active');
              appContainer.classList.remove('active');
              chatContainer.style.display = 'none';
          }
      });

      // Sign up
      signupBtn.addEventListener('click', async () => {
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;
          const username = prompt("Please enter a username:");
          const town = prompt("Please enter your town:");

          if (username && town) {
              try {
                  const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                  const user = userCredential.user;
                  await set(ref(db, 'users/' + user.uid), {
                      username: username,
                      email: email,
                      town: town
                  });
                  alert('Sign up successful!');
              } catch (error) {
                  alert(error.message);
              }
          } else {
              alert('Username and town are required.');
          }
      });

      // Login
      loginBtn.addEventListener('click', async () => {
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;
          try {
              await signInWithEmailAndPassword(auth, email, password);
          } catch (error) {
              alert(error.message);
          }
      });

      // Logout
      logoutBtn.addEventListener('click', async () => {
          await signOut(auth);
      });

      // Load user profile
      function loadUserProfile(userId) {
          const userRef = ref(db, 'users/' + userId);
          onValue(userRef, (snapshot) => {
              const data = snapshot.val();
              if (data) {
                  profileUsernameSpan.textContent = data.username;
                  profileTownSpan.textContent = data.town;
              }
          });
      }

      // Search for users
      searchBtn.addEventListener('click', async () => {
          const searchTerm = searchUsernameInput.value.trim();
          if (searchTerm === "") return;

          const usersRef = ref(db, 'users');
          const snapshot = await get(usersRef);
          searchResultsDiv.innerHTML = '';
          if (snapshot.exists()) {
              snapshot.forEach(childSnapshot => {
                  const userData = childSnapshot.val();
                  if (userData.username.toLowerCase().includes(searchTerm.toLowerCase()) && childSnapshot.key !== currentUserId) {
                      const userCard = document.createElement('div');
                      userCard.className = 'user-card';
                      userCard.innerHTML = `
                          <div>
                              <strong>${userData.username}</strong><br>
                              <small>${userData.town}</small>
                          </div>
                          <button class="send-request-btn" data-uid="${childSnapshot.key}">Send Request</button>
                      `;
                      searchResultsDiv.appendChild(userCard);
                  }
              });
          } else {
              searchResultsDiv.textContent = 'No users found.';
          }
      });

      // Send friend request
      searchResultsDiv.addEventListener('click', async (e) => {
          if (e.target.classList.contains('send-request-btn')) {
              const toUserId = e.target.dataset.uid;
              const requestsRef = ref(db, `users/${toUserId}/friendRequests/${currentUserId}`);
              await set(requestsRef, { status: 'pending' });
              alert('Friend request sent!');
          }
      });

      // Load friend requests
      function loadFriendRequests(userId) {
          const requestsRef = ref(db, `users/${userId}/friendRequests`);
          onValue(requestsRef, async (snapshot) => {
              friendRequestsDiv.innerHTML = '';
              if (snapshot.exists()) {
                  for (const fromUserId in snapshot.val()) {
                      if (snapshot.val()[fromUserId].status === 'pending') {
                          const userSnapshot = await get(child(ref(db, 'users'), fromUserId));
                          if (userSnapshot.exists()) {
                              const userData = userSnapshot.val();
                              const requestCard = document.createElement('div');
                              requestCard.className = 'request-card';
                              requestCard.innerHTML = `
                                  <span>${userData.username}</span>
                                  <div>
                                      <button class="accept-btn" data-uid="${fromUserId}">Accept</button>
                                      <button class="decline-btn" data-uid="${fromUserId}">Decline</button>
                                  </div>
                              `;
                              friendRequestsDiv.appendChild(requestCard);
                          }
                      }
                  }
              }
          });
      }

      // Accept or Decline Friend Request
      friendRequestsDiv.addEventListener('click', async (e) => {
          const fromUserId = e.target.dataset.uid;
          const myRequestsRef = ref(db, `users/${currentUserId}/friendRequests/${fromUserId}`);

          if (e.target.classList.contains('accept-btn')) {
              await set(myRequestsRef, { status: 'accepted' });
              await set(ref(db, `users/${fromUserId}/friendRequests/${currentUserId}`), { status: 'accepted' });

              await set(ref(db, `users/${currentUserId}/friends/${fromUserId}`), true);
              await set(ref(db, `users/${fromUserId}/friends/${currentUserId}`), true);

              alert('Friend request accepted!');
          } else if (e.target.classList.contains('decline-btn')) {
              await set(myRequestsRef, { status: 'declined' });
              alert('Friend request declined.');
          }
      });

      // Load friends
      function loadFriends(userId) {
          const friendsRef = ref(db, `users/${userId}/friends`);
          onValue(friendsRef, async (snapshot) => {
              friendsListDiv.innerHTML = '';
              if (snapshot.exists()) {
                  for (const friendId in snapshot.val()) {
                      const userSnapshot = await get(child(ref(db, 'users'), friendId));
                      if (userSnapshot.exists()) {
                          const userData = userSnapshot.val();
                          const friendCard = document.createElement('div');
                          friendCard.className = 'friend-card';
                          friendCard.innerHTML = `
                              <span>${userData.username}</span>
                              <button class="chat-btn" data-uid="${friendId}" data-username="${userData.username}">Chat</button>
                          `;
                          friendsListDiv.appendChild(friendCard);
                      }
                  }
              }
          });
      }

      // Start chat
      friendsListDiv.addEventListener('click', (e) => {
          if (e.target.classList.contains('chat-btn')) {
              currentChattingWith = e.target.dataset.uid;
              const username = e.target.dataset.username;
              chatContainer.style.display = 'block';
              chatWithUsernameSpan.textContent = username;
              loadChatMessages(currentChattingWith);
          }
      });

      // Get chat ID
      function getChatId(userId1, userId2) {
          return userId1 < userId2 ? `${userId1}_${userId2}` : `${userId2}_${userId1}`;
      }

      // Load chat messages
      function loadChatMessages(friendId) {
          const chatId = getChatId(currentUserId, friendId);
          const messagesRef = ref(db, `chats/${chatId}/messages`);

          onValue(messagesRef, (snapshot) => {
              chatMessagesDiv.innerHTML = '';
              if (snapshot.exists()) {
                  snapshot.forEach(childSnapshot => {
                      const messageData = childSnapshot.val();
                      const messageDiv = document.createElement('div');
                      messageDiv.className = 'message' + (messageData.senderId === currentUserId ? ' sent' : '');
                      messageDiv.innerHTML = `<span class="sender">${messageData.senderUsername}:</span> ${messageData.text}`;
                      chatMessagesDiv.appendChild(messageDiv);
                  });
                  chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
              }
          });
      }

      // Send message
      sendMessageBtn.addEventListener('click', async () => {
          const text = messageInput.value.trim();
          if (text === "" || !currentChattingWith) return;

          const chatId = getChatId(currentUserId, currentChattingWith);
          const messagesRef = ref(db, `chats/${chatId}/messages`);
          const newMessageRef = push(messagesRef);

          const currentUserSnapshot = await get(child(ref(db, 'users'), currentUserId));
          const currentUserData = currentUserSnapshot.val();

          await set(newMessageRef, {
              senderId: currentUserId,
              senderUsername: currentUserData.username,
              text: text,
              timestamp: Date.now()
          });

          messageInput.value = '';
      });
    </script>
</body>
   </html>
